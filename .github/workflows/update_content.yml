name: Update Content List

on:
  push:
    paths:
      - 'Games/**'
      - 'Interactive_Activities/**'
      - 'Vocabulary/**'
      - 'Videos/**'
      - 'Grammar/**'   # YENÄ°
      - 'Slides/**'    # YENÄ°
      - 'Documents/**' # YENÄ°
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v3

    - name: Generate JSON with FULL Support
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          // KLASÃ–R TANIMLARI
          const dirs = {
            'Games': 'Games',
            'Interactive_Activities': 'Interactive_Activities',
            'Vocabulary': 'Vocabulary',
            'Videos': 'Videos',
            'Grammar': 'Grammar',
            'Slides': 'Slides',
            'Documents': 'Documents'
          };
          
          const outputFile = 'games_data.json';
          let results = [];
          let existingData = {};

          // --- HAFIZA OKUMA ---
          if (fs.existsSync(outputFile)) {
            try {
              const rawData = fs.readFileSync(outputFile, 'utf8');
              const json = JSON.parse(rawData);
              json.forEach(item => { existingData[item.path] = item; });
            } catch (e) { console.log("Eski veri okunamadÄ±."); }
          }

          function createEntry(realPath, name, defaultGrade, defaultSource) {
             const old = existingData[realPath];
             
             // UzantÄ±larÄ± temizle
             const cleanName = name.replace(/\.(html|pdf|docx|doc|xlsx|xls|ppt|pptx)$/i, '').replace(/_/g, ' ');
             const finalTitle = (old && old.title) ? old.title : cleanName;
             const finalSource = (old && old.source) ? old.source : defaultSource;

             // VarsayÄ±lan Renkler (Bootstrap sÄ±nÄ±flarÄ±)
             let defColor = 'bg-primary';
             if (finalSource === 'Interactive_Activities') defColor = 'bg-info';
             if (finalSource === 'Vocabulary') defColor = 'bg-success';
             if (finalSource === 'Videos') defColor = 'bg-danger';
             if (finalSource === 'Grammar') defColor = 'bg-warning text-dark';
             if (finalSource === 'Slides') defColor = 'bg-dark'; // Mor yerine koyu
             if (finalSource === 'Documents') defColor = 'bg-info';

             return {
                path: realPath,
                name: name,
                title: finalTitle,
                description: (old && old.description) ? old.description : "Click to view.",
                grade: (old && old.grade) ? old.grade : defaultGrade,
                source: finalSource,
                unit: (old && old.unit) ? old.unit : "",
                badgeColor: (old && old.badgeColor) ? old.badgeColor : defColor,
                isFeatured: (old && old.isFeatured) ? old.isFeatured : false,
                isVisible: (old && old.isVisible !== undefined) ? old.isVisible : true
             };
          }

          // --- TARAMA FONKSÄ°YONU ---
          // Her klasÃ¶r iÃ§in ayrÄ± ayrÄ± if yazmak yerine dÃ¶ngÃ¼ye aldÄ±m, daha temiz oldu.
          Object.keys(dirs).forEach(sourceType => {
            const dirPath = dirs[sourceType];
            
            if (fs.existsSync(dirPath)) {
              fs.readdirSync(dirPath).forEach(grade => {
                const gradePath = path.join(dirPath, grade);
                if (fs.statSync(gradePath).isDirectory()) {
                  fs.readdirSync(gradePath).forEach(file => {
                    const fullPath = path.join(gradePath, file);
                    const webPath = `${dirPath}/${grade}/${file}`; // Web uyumlu yol

                    // 1. KLASÃ–R TÄ°PÄ° (Games iÃ§in)
                    if (fs.statSync(fullPath).isDirectory()) {
                        if (fs.existsSync(path.join(fullPath, 'index.html'))) {
                            results.push(createEntry(`${webPath}/index.html`, file, grade, sourceType));
                        }
                    } 
                    // 2. DOSYA TÄ°PÄ° (DiÄŸerleri iÃ§in)
                    else {
                        // Hangi uzantÄ±larÄ± kabul edelim?
                        // Slides iÃ§in PPT ekle, diÄŸerleri standart
                        let regex = /\.(html|pdf|docx|doc|xlsx|xls)$/i;
                        if (sourceType === 'Slides') {
                            regex = /\.(html|pdf|docx|doc|xlsx|xls|ppt|pptx)$/i;
                        }

                        if (file.match(regex)) {
                            results.push(createEntry(webPath, file, grade, sourceType));
                        }
                    }
                  });
                }
              });
            }
          });

          fs.writeFileSync(outputFile, JSON.stringify(results, null, 2));

    - name: Commit and Push
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        git add games_data.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "Updated: Added Grammar, Slides, Documents ðŸš€" && git push)
