name: Update Content List

on:
  push:
    paths:
      - 'Games/**'
      - 'Interactive_Activities/**'
      - 'Vocabulary/**'  # Yeni klasÃ¶r eklendi
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v3

    - name: Generate JSON with MULTI-FILE Support
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          const gamesDir = 'Games';
          const activitiesDir = 'Interactive_Activities';
          const vocabDir = 'Vocabulary'; // Yeni BÃ¶lÃ¼m
          const outputFile = 'games_data.json';
          
          let results = [];
          let existingData = {};

          // --- HAFIZA OKUMA ---
          if (fs.existsSync(outputFile)) {
            try {
              const rawData = fs.readFileSync(outputFile, 'utf8');
              const json = JSON.parse(rawData);
              json.forEach(item => { existingData[item.path] = item; });
            } catch (e) { console.log("Eski veri okunamadÄ±."); }
          }

          function createEntry(realPath, name, defaultGrade, defaultSource) {
             const old = existingData[realPath];
             
             // Dosya uzantÄ±sÄ±nÄ± temizle (html, pdf, docx, xlsx)
             const cleanName = name.replace(/\.(html|pdf|docx|xlsx)$/i, '').replace(/_/g, ' ');
             const finalTitle = (old && old.title) ? old.title : cleanName;
             const finalSource = (old && old.source) ? old.source : defaultSource;

             // VarsayÄ±lan renk ayarÄ± (Vocabulary ise YeÅŸil)
             let defColor = 'bg-primary';
             if (finalSource === 'Interactive_Activities') defColor = 'bg-info';
             if (finalSource === 'Vocabulary') defColor = 'bg-success';

             return {
                path: realPath,
                name: name,
                title: finalTitle,
                description: (old && old.description) ? old.description : "Click to view file.",
                grade: (old && old.grade) ? old.grade : defaultGrade,
                source: finalSource,
                unit: (old && old.unit) ? old.unit : "",
                badgeColor: (old && old.badgeColor) ? old.badgeColor : defColor,
                isFeatured: (old && old.isFeatured) ? old.isFeatured : false,
                isVisible: (old && old.isVisible !== undefined) ? old.isVisible : true
             };
          }

          // 1. GAMES TARAMASI
          if (fs.existsSync(gamesDir)) {
            fs.readdirSync(gamesDir).forEach(grade => {
              const gradePath = path.join(gamesDir, grade);
              if (fs.statSync(gradePath).isDirectory()) {
                fs.readdirSync(gradePath).forEach(gameName => {
                  const gamePath = path.join(gradePath, gameName);
                  if (fs.statSync(gamePath).isDirectory() && fs.existsSync(path.join(gamePath, 'index.html'))) {
                    const fullPath = `${gamesDir}/${grade}/${gameName}/index.html`;
                    results.push(createEntry(fullPath, gameName, grade, 'Games'));
                  }
                });
              }
            });
          }

          // 2. INTERACTIVE ACTIVITIES TARAMASI (Sadece HTML)
          if (fs.existsSync(activitiesDir)) {
            fs.readdirSync(activitiesDir).forEach(grade => {
              const gradePath = path.join(activitiesDir, grade);
              if (fs.statSync(gradePath).isDirectory()) {
                fs.readdirSync(gradePath).forEach(file => {
                  if (file.endsWith('.html')) {
                    const fullPath = `${activitiesDir}/${grade}/${file}`;
                    results.push(createEntry(fullPath, file, grade, 'Interactive_Activities'));
                  }
                });
              }
            });
          }

          // 3. VOCABULARY TARAMASI (HTML, PDF, DOCX, XLSX)
          if (fs.existsSync(vocabDir)) {
            fs.readdirSync(vocabDir).forEach(grade => {
              const gradePath = path.join(vocabDir, grade);
              if (fs.statSync(gradePath).isDirectory()) {
                fs.readdirSync(gradePath).forEach(file => {
                  // Kabul edilen uzantÄ±lar
                  if (file.match(/\.(html|pdf|docx|xlsx)$/i)) {
                    const fullPath = `${vocabDir}/${grade}/${file}`;
                    results.push(createEntry(fullPath, file, grade, 'Vocabulary'));
                  }
                });
              }
            });
          }

          fs.writeFileSync(outputFile, JSON.stringify(results, null, 2));

    - name: Commit and Push
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        git add games_data.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "Updated Content List with Vocabulary ðŸ“š" && git push)
